<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YYC Transit Dash</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #121212; color: white; padding: 20px; }
        .stop-card { background: #1e1e1e; border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 6px solid #ff0000; display: flex; justify-content: space-between; align-items: center; }
        .route-num { font-size: 26px; font-weight: 900; color: #ff0000; margin-right: 15px; }
        .time { font-size: 18px; font-weight: 700; }
        .btn { background: #333; color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <h2>YYC Transit Dash</h2>
    <div id="transit-list">Connecting to Calgary Transit...</div>
    <button class="btn" onclick="loadTransitData()">ðŸ”„ Refresh</button>

    <script>
        const STOP_ID = '6015'; // City Hall Station

        // 1. The Callback Function: This is what runs when the data arrives
        function handleTransitData(data) {
            const listDiv = document.getElementById('transit-list');
            if (!data || data.length === 0) {
                listDiv.innerHTML = "No upcoming trips found.";
                return;
            }

            let html = '';
            data.slice(0, 5).forEach(trip => {
                html += `
                    <div class="stop-card">
                        <div class="route-num">${trip.route_short_name}</div>
                        <div style="flex-grow:1">
                            <div style="font-size:14px; opacity:0.8;">${trip.trip_headsign}</div>
                            <div class="time">${trip.departure_time.substring(0,5)}</div>
                        </div>
                    </div>`;
            });
            listDiv.innerHTML = html;
        }

        // 2. The JSONP Request: Disguising the data request as a script
        function loadTransitData() {
            // Remove old script if it exists
            const oldScript = document.getElementById('jsonp-request');
            if (oldScript) oldScript.remove();

            const script = document.createElement('script');
            script.id = 'jsonp-request';
            // We add $jsonp=handleTransitData to tell Socrata to wrap the JSON in our function
            script.src = `https://data.calgary.ca/resource/m7v3-pkh6.json?stop_id=${STOP_ID}&$limit=5&$jsonp=handleTransitData`;
            
            document.body.appendChild(script);
        }

        // Initial load
        loadTransitData();
    </script>
</body>
</html>
